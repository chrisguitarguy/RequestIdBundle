[![Minimum PHP Version](https://img.shields.io/badge/php-%3E%3D%208.1-8892BF)](https://php.net/)

# Symfony Request Id

*Based on [chrisguitarguy/RequestIdBundle](https://github.com/chrisguitarguy/RequestIdBundle)*

This adds request ID's to your Symfony application. Why? It's a great way to add
some additional information to logs and to present to users. For example, if an
exception is thrown you'll be able to show the user the request ID which they
can pass on to you to locate their specific issue.

## Installation

Use [Composer](https://getcomposer.org/).

```
composer require digitalrevolution/symfony-request-id
```
And one of the UUIDv4 generator libraries:
```shell
composer require ramsey/uuid
# OR
composer require symfony/uid
```


Then enable the bundle in your `/config/bundles.php`:

```php
# /config/bundles.php
<?php

return [
    ...
    DR\SymfonyRequestId\RequestIdBundle::class => ['all' => true],
];
```

## Configuration

```php
# /config/packages/symfony-request-id.php
<?php
declare(strict_types=1);

use DR\SymfonyRequestId\Generator\RamseyUuid4Generator;
use DR\SymfonyRequestId\RequestId\SimpleIdStorage;
use Symfony\Config\SymfonyRequestIdConfig;

return static function (SymfonyRequestIdConfig $config): void {
    // The header which the bundle inspects for the incoming request ID
    // if this is not set an ID will be generated and set at this header
    $config->requestHeader('X-Request-Id');

    // Whether to trust the incoming request header. This is turned
    // on by default. If true a value in the `X-Request-Id` header in the request
    // will be used as the request ID for the rest of the request. If false
    // those values are ignored.
    $config->trustRequestHeader(true);

    // The header which the bundle will set the request ID to on the response
    $config->responseHeader('X-Request-Id');

    // The service key of an object that implements
    // DR\SymfonyRequestId\RequestIdStorage
    $config->storageService(SimpleIdStorage::class);

    // The service key of an object that implements
    // DR\SymfonyRequestId\RequestIdGenerator
    // Optional, will default to Symfony's Uuid or Ramsey's Uuid.
    $config->generatorService(RamseyUuid4Generator::class);

    // Whether to add the monolog process, defaults to true
    $config->enableMonolog(true);
    
    // Whether to generate a request ID for console commands, defaults to true
    $config->enableConsole(true);

    // Whether to add the twig extension, defaults to true
    $config->enableTwig(true);
};
```

## How it Works

When a request arrives, it is inspected for the `X-Request-Id` header. If present,
the value in that header will be used throughout the rest of the bundle. This
lets you use request ID's from somewhere higher up in the stack (like in the web
server itself).

If no request ID is found, one is generated by the `RequestIdGenerator`. The
default generator creates version 4 UUIDs.

On the way out, the `X-Request-Id` header is set on the response as well using
the value described above.

The headers are configurable. See the [configuration](#configuration) above.

## Monolog Integration

There's a monolog *Processor* that adds the request ID to `extra` array on the
record. This can be turned off by setting `enable_monolog` to `false` in the
configuration.

To use the request ID in your logs, include `%extra.request_id%` in your
formatter. Here's a configuration example from this bundle's tests.

```php
# /config/services.php
$services->set('request_id_formatter', LineFormatter::class)
    ->arg('$format', "[%%datetime%%][%%extra.request_id%%] %%channel%%.%%level_name%%: %%message%% %%extra%%\n")
    ->arg('$dateFormat', "Y-m-d\TH:i:s");
```
```php
# /config/packages/monolog.php
$monolog->handler('main')
        ->type('stream')
        ->path('%kernel.logs_dir%/error.%kernel.environment%.log')
        ->level('debug')
        ->formatter('request_id_formatter')        
        ->channels()->elements(["!event"]);
```

## Twig Integration

By default this bundle will add a global `request_id` function to your twig
environment. To disable this set `enable_twig` to `false` in the bundle
configuration.

Here's an example of a template.

```html
<!DOCTYPE html>
<html>
    <head>
        <title>Hello, World</title>
    </head>
    <body>
        <h1>{{ request_id() }}</h1>
    </body>
</html>
```

## About us

At 123inkt (Part of Digital Revolution B.V.), every day more than 50 development professionals are working on improving our internal ERP 
and our several shops. Do you want to join us? [We are looking for developers](https://www.werkenbij123inkt.nl/zoek-op-afdeling/it).
